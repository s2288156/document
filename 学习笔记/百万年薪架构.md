[toc]

# 智能互联网关键系统实践

## 01 互联网注册中心设计与实践

> 关键词：gossip算法、craf

## 02 互联网配置中心设计与实践

apollo配置中心client与server之间是Long Polling实现：

- Long Polling是通过client发送请求，超时时间60秒，server端收到请求后不会立即返回，而是等待60秒，如果有返回值，则返回，如果没有则返回空。
- client收到返回后，再次发起请求
- 考虑到会有数万的client发起长连接，服务端采用了async servlet(String DeferredResult)来服务HTTP Long Polling请求。

## 03 分布式消息队列与实践

### RocketMQ存储模型

**顺序写，随机读：**

- 所有的数据单独存储在一个Commit Log，完全顺序写，随机读
- 对最终用户展现的队列实际只存储消息再Commit Log的**位置信息**，并且串行化刷盘
- 好处：
    - 队列轻量化，单个队列数据量非常小
    - 对磁盘的访问串行化，防止磁盘竞争
- 缺点：
    - 写顺序写，但读完全随机
    - 读一条消息，先读Consume Queue，再读Commit Log，增加了读开销
    - 要保证Commit Log与Consume Queue完全一致，增加了架构设计的复杂性

### RocketMQ刷盘策略

> 关键词MMAP，将内存和硬盘映射，写内存同时写硬盘的一种策略

以下为个人理解

什么叫做**刷盘：** 消息通过MMAP机制，写入内存后需要同步写入磁盘，称为刷盘。刷盘策略分为**异步刷盘**和**同步刷盘**，在broker中进行

## 04 分布式请求跟踪系统

**关键点：**

- 请求链唯一标识（TraceID）
- 时序标识（SequenceID）
- 深度标识（DepthID

## 05 服务管理平台

- 服务管理平台
    - 服务管理平台抽象出服务特征，对服务提供者和服务调用者分别提供可视化管理界面
    - 服务发布之前需要进行注册，服务节点上线必须要在服务管理平台确认
    - 调用服务必须通过工单申请，经过服务提供方统一，按需申请，按需调用
- 功能
    - 管理：双方平台注册、在线管理、平台发布管控指令、配置管理、服务熔断/降级、调用关系控制
    - 度量：服务质量、健康指数、问题追逐

## 06 智能个性化推荐系统设计与实践

机器学习书籍：李航、周志华

**推荐系统构成：**

- 召回层：对海量数据进行召回
- 排序层：
    - 对召回数据进行排序
    - 排序结果返回给用户

![b9e81ada9fd7c21a239f357c3f53e355.png](en-resource://database/1848:1)

冷启动 -> 基于内容的推荐 -> 基于行为的推荐 -> 相关性计算 -> 结果排序 -> 推荐工程架构

## 07 智能搜索系统设计与实践


### ES

- 倒排索引
- 热点数据，自动复制到空闲节点

监控框架：Kopf、Marval（官方）

## 08 容器化

### k8s

- 一个状态存储：etcd集群
- API声明式
- 多个控制器

**k8s支撑业务类型：**

- 长期伺服型（long-running）
    - 业务服务
- 批处理型（batch）
    - Job
- 节点后台支撑（node-daemon）
    - 日志和监控
    - Log-pilot
- 有状态应用型（stateful application）
    - MySQL
    - TiDB
    - Redis

**K8Ss设计目标：**

- 云计算环境服务作用距离范围（从近到远）
    - 同主机（Host,Node）同一个物理机
    - 跨主机同可用区（Available Zone）同一个机房
    - 跨可用区同地区（Region）同地区不同机房
    - 跨地区同服务商（Cloud Service Provider）不同地区，同服务商
    - 跨云平台

- Kuabernetes设计目标
    - 单一集群在同一地区
        - 同一地区的网络性能才能满足k8s的调度和计算存储连接要求

**容器云平台网络方案对比：**

- 优先Bridge，其次Overlay，备选Host

| 对比维度            | TCP损耗 | UDP损耗 |
| ------------------- | ------- | ------- |
| Host                | 0       | 27.9%   |
| Bridge / 宿主机通信 | 0       | 0       |



## 9. 服务网格架构设计与实践



> 关键词：sidecar、service mesh、



> OpenSource: linkerd、**Istio**



**顶层架构设计：**

- SideCar
  - 数据面板
- Srvmgr
  - 服务管理平台
- Control Center
  - 控制中心
- Collector
  - 数据收集中心